// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ENUMS
// =============================================================================

enum Sex {
  MALE
  FEMALE
}

enum Visibility {
  PUBLIC
  PRIVATE
  CUSTOM
}

enum LockReason {
  THIRST_TRAP
  INAPPROPRIATE_CONTENT
  HARASSMENT
  SPAM
  OTHER
}

enum ShareType {
  REPOST // Simple repost to own feed
  QUOTE // Share with added commentary
  MESSAGE // Shared via direct message
}

// =============================================================================
// USER & PROFILE
// =============================================================================

model User {
  id            String       @id @default(uuid())
  displayName   String       @unique
  email         String       @unique
  password      String
  profile       Profile?
  roles         UserRole[]
  posts         Post[]
  viewablePosts PostViewer[]
  likes         Like[]
  comments      Comment[]
  shares        Share[]
  postReports   PostReport[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model Profile {
  id          String             @id @default(uuid())
  userId      String             @unique
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName   String
  lastName    String
  dateOfBirth DateTime
  sex         Sex
  bio         String?
  metadata    Json?
  visibility  ProfileVisibility?
  theme       ProfileTheme?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model ProfileVisibility {
  id          String   @id @default(uuid())
  profileId   String   @unique
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  firstName   Boolean  @default(true)
  lastName    Boolean  @default(true)
  dateOfBirth Boolean  @default(false)
  sex         Boolean  @default(false)
  bio         Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// =============================================================================
// ROLES & PERMISSIONS (RBAC)
// =============================================================================

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Permission {
  id        String           @id @default(uuid())
  name      String           @unique
  roles     RolePermission[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

/// Join table: User ↔ Role
model UserRole {
  userId    String
  roleId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, roleId])
}

/// Join table: Role ↔ Permission
model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@id([roleId, permissionId])
}

// =============================================================================
// POSTS & FEED
// =============================================================================

model Post {
  id        String   @id @default(uuid())
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content   String
  mediaUrls String[]

  // Visibility
  visibility    Visibility   @default(PUBLIC)
  customViewers PostViewer[]

  // Moderation lock
  isLocked           Boolean     @default(false)
  lockReason         LockReason?
  lockedAt           DateTime?
  lockedById         String?
  lockNote           String?
  autoLockedBySystem Boolean     @default(false)
  reportCount        Int         @default(0)

  // Engagement relations
  likes    Like[]
  comments Comment[]
  shares   Share[]
  reports  PostReport[]

  // Denormalized counts (for performance)
  likesCount    Int @default(0)
  commentsCount Int @default(0)
  sharesCount   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId])
  @@index([visibility])
  @@index([isLocked])
  @@index([createdAt])
}

/// Join table: Post custom visibility (specific users who can view)
model PostViewer {
  postId    String
  viewerId  String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  viewer    User     @relation(fields: [viewerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([postId, viewerId])
  @@index([viewerId])
}

// =============================================================================
// ENGAGEMENT (Likes, Comments, Shares)
// =============================================================================

model Like {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Comment {
  id         String    @id @default(uuid())
  postId     String
  post       Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId   String
  author     User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content    String
  parentId   String?
  parent     Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    Comment[] @relation("CommentReplies")
  likesCount Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

model Share {
  id        String    @id @default(uuid())
  postId    String
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  shareType ShareType @default(REPOST)
  caption   String?
  createdAt DateTime  @default(now())

  @@index([postId])
  @@index([userId])
}

// =============================================================================
// MODERATION
// =============================================================================

model PostReport {
  id           String     @id @default(uuid())
  postId       String
  post         Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporterId   String
  reporter     User       @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  reason       LockReason
  description  String?
  reviewed     Boolean    @default(false)
  reviewedAt   DateTime?
  reviewedById String?
  createdAt    DateTime   @default(now())

  @@index([postId])
  @@index([reporterId])
  @@index([reviewed])
}

// ============================================================================
// THEME
// =============================================================================

model ProfileTheme {
  id        String   @id @default(uuid())
  profileId String   @unique
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
}
